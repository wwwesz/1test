function add_oval(a,e,t){var s,n,r=new Array,o=e/t;for(i=0;i<36;i++)s=2*Math.PI/36*i,n=new BMap.Point(a.lng+Math.sin(s)*t*o,a.lat+Math.cos(s)*t),r.push(n);return r}function flushHouseList(a){$(".js_houseList > a.js_DomModal").remove();for(var e in a){var t=$(contentModalStr).appendTo(".js_houseList");t.attr("href","/house/"+a[e].guid).attr("title",a[e].title),t.find("img").attr("src",a[e].house_img),t.find("li.js_acreage").html(a[e].acreage+"㎡"),t.find("li.js_unit_price").html(a[e].unit_price+"元/㎡·月"),t.find("li.js_total_price").html(a[e].total_price+"元/月")}nowHouseData=a}function getCountsArr(a,e,t,s){var n=[];if(s)for(var r in a)a[r][e]>=t&&a[r][e]<=s&&n.push(a[r]);else for(var r in a)a[r][e]>t&&n.push(a[r]);return n}function countShowNum(){for(var a=0;a<$(".js_show_num").length;a++){var e=".js_show_num:eq("+a+")";$(e).html(function(a){var e=a.parents(".js_count").attr("data-min"),t=a.parents(".js_count").attr("data-max"),s=a.parents(".js_point").hasClass("js_selectPrice")?"unit_price":"acreage";return getCountsArr(initHouseData,s,e,t).length}($(e)))}}function setSelected(a){var e=a.attr("data-min")||null,t=a.attr("data-max")||null,s=$("li.js_count.active");if(null!==e)if(1===s.length){var n=a.parents(".js_point").hasClass("js_selectPrice")?"unit_price":"acreage",r=getCountsArr(initHouseData,n,e,t);flushHouseList(r),function(){for(var e=a.parents(".js_point").hasClass("js_selectPrice")?$(".js_selectAcreage"):$(".js_selectPrice"),t=0;t<e.find("span.js_show_num").length;t++){var s=e.find("span.js_show_num").eq(t);s.html(function(a){var e=a.parents(".js_count").attr("data-min"),t=a.parents(".js_count").attr("data-max"),s=a.parents(".js_point").hasClass("js_selectPrice")?"unit_price":"acreage";return getCountsArr(nowHouseData,s,e,t).length}(s))}}()}else{var i=s.eq(0).attr("data-min")||null,o=s.eq(0).attr("data-max")||null,l=s.eq(1).attr("data-min")||null,u=s.eq(1).attr("data-max")||null,c=getCountsArr(initHouseData,"acreage",i,o),p=getCountsArr(c,"unit_price",l,u);flushHouseList(p),function(){for(var a=$("span.js_show_num"),e=0;e<a.length;e++){var t=a.eq(e),s=t.parents(".js_point").hasClass("js_selectPrice")?$(".js_selectAcreage"):$(".js_selectPrice");console.log(t.parents(".js_point").hasClass("js_selectPrice")),t.html(function(a,e){var t=e.find("li.js_count.active").attr("data-min")||null,s=e.find("li.js_count.active").attr("data-max")||null,n=e.hasClass("js_selectPrice")?"unit_price":"acreage",r=getCountsArr(initHouseData,n,t,s),i=a.parents(".js_count").attr("data-min")||null,o=a.parents(".js_count").attr("data-max")||null;return getCountsArr(r,a.parents(".js_point").hasClass("js_selectPrice")?"unit_price":"acreage",i,o).length}(t,s))}}()}else 0===s.length?(countShowNum(),flushHouseList(initHouseData)):(setSelected($("li.js_count.active")),countShowNum(),function(a){for(var e=a.parents(".js_point").hasClass("js_selectPrice")?$(".js_selectPrice"):$(".js_selectAcreage"),t=0;t<e.find("span.js_show_num").length;t++){var s=$("ul.js_select_ul ol").eq(e).find("span.js_counts").eq(t).find(".show_num");s.html(function(a){var e=a.parents(".js_count").attr("data-min"),t=a.parents(".js_count").attr("data-max"),s=a.parents(".js_count").attr("data-field");return getCountsArr(nowHouseData,s,e,t).length}(s))}}(a));$("span.js_allHouseNum").html(nowHouseData.length)}function setOrder(a,e){var t=dataSort(a);e||t.reverse(),flushHouseList(t)}function dataSort(a){for(var e=nowHouseData,t=0;t<e.length;t++)for(var s=t+1;s<e.length;s++)if(e[t][a]<e[s][a]){var n=e[t];e[t]=e[s],e[s]=n}return e}function GetRequest(){var a=location.search,e=new Object;if(-1!=a.indexOf("?")){var t=a.substr(1);strs=t.split("&");for(var s=0;s<strs.length;s++)e[strs[s].split("=")[0]]=unescape(strs[s].split("=")[1])}return e}function isStringNoon(a){var e=a.val();0===a.parent("div").find("label.error").length?""===e.trim()&&a.after('<label class="error">此处为必填项'):""!==e.trim()&&a.parent("div").find("label.error").remove()}function isTel(a){isStringNoon(a);var e=a.val(),t=/^1(3|4|5|7|8)\d{9}$/;0===a.parent("div").find("label.error").length?t.test(e)||a.after('<label class="error">请填写正确的电话号码'):t.test(e)&&a.parent("div").find("label.error").remove()}var mp=new BMap.Map("allmap",{enableMapClick:!1}),gps=$("input#gps").val().split(",");mp.centerAndZoom(new BMap.Point(gps[0],gps[1]),18);var local=new BMap.LocalSearch(mp,{renderOptions:{map:mp,autoViewport:!0}});local.searchNearby("公交",new BMap.Point(gps[0],gps[1]));var myIcon=new BMap.Icon($("input#mapPosition").val(),new BMap.Size(20,32)),marker2=new BMap.Marker(new BMap.Point(gps[0],gps[1]),{icon:myIcon});mp.addOverlay(marker2);var oval=new BMap.Polygon(add_oval(new BMap.Point(gps[0],gps[1]),.025,.02),{strokeColor:"blue",strokeWeight:1,strokeOpacity:.25});mp.addOverlay(oval),$(".js_changeMap li").click(function(){$(".js_changeMap li").removeClass("active"),$(this).addClass("active"),mp.clearOverlays(),mp.addOverlay(marker2),mp.addOverlay(oval),new BMap.LocalSearch(mp,{renderOptions:{map:mp,autoViewport:!1}}).searchNearby($(this).html(),new BMap.Point(gps[0],gps[1]))});var initHouseData=JSON.parse($("input#initHouseData").val()),contentModalStr=$(".js_houseList > a.js_DomModal").eq(0).prop("outerHTML"),nowHouseData=initHouseData;countShowNum(),$(".js_count").click(function(){$(this).parents("div.js_point").find(".js_count").removeClass("active"),$(this).addClass("active"),setSelected($(this))}),$(".js_sort").click(function(){$(this).hasClass("active")?($(this).find("i").toggleClass("fa-arrow-up"),$(this).find("i").toggleClass("fa-arrow-down")):$(".fa-arrow-up").removeClass("fa-arrow-up").addClass("fa-arrow-down"),setOrder($(this).data("field"),$(this).find("i").hasClass("fa-arrow-down")),$(this).parents(".js_point").find(".js_sort").removeClass("active"),$(this).addClass("active")}),$(document).on("click","span.js_bookHouse",function(){var a=$(this).data("guid");return $(".userBespeakHouse").data("house_guid",a),$("#myBespeakModal").modal("show"),!1}),$(".userBespeakHouse").click(function(){var a=$(this).data("house_guid"),e=$("#tel").val(),t=$("#name").val();if($("#tel").trigger("blur"),$("#name").trigger("blur"),$("#bespeak-form label.error").length-$("#bespeak-form label.error:hidden").length>0)return!1;var s={name:t,tel:e,house_guid:a,bespeak_source:1},n=GetRequest();isNaN(n.spread)||(s.spread=n.spread),n.idea&&(s.idea=n.idea),$.ajax({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},type:"POST",url:"/bespeak",dataType:"json",data:s,success:function(a){200===a.StatusCode?($("#tel").val(""),$("#name").val(""),$("#myBespeakModal").modal("hide"),swal("预约成功!","稍后管理员将与您取得联系!","success")):($("#tel").val(""),$("#name").val(""),$("#myBespeakModal").modal("hide"),swal("警告⚠️",a.ResultData,"error"))}})}),$(function(){$("#mySwiper").swiper({paginationClickable:!0,pagination:".swiper-pagination",autoplay:3e3,autoplayDisableOnInteraction:!1}),$(".js_clickTarget li a").click(function(){$(".js_clickTarget li.active").removeClass("active"),$(this).parent("li").addClass("active")})});